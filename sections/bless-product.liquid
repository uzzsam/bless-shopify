{% liquid
  assign product = all_products[section.settings.product]
  assign selected_variant = nil
  if product
    assign selected_variant = product.selected_or_first_available_variant
  endif
  assign panel_rgb = section.settings.panel_background | default: '65, 65, 65'
  assign panel_opacity = section.settings.panel_opacity | default: 70 | times: 0.01
  assign require_blessing = section.settings.require_blessing | default: true
  assign form_id = 'BlessProductForm-' | append: section.id
%}

<section
  id="product-section"
  class="bless-product{% if settings.bless_body_background != blank %} bless-shared-background bless-shared-background--overlay{% endif %}"
  data-section-id="{{ section.id }}"
  data-require-blessing="{{ require_blessing }}"
>
  <div class="bless-product__inner">
    {% if section.settings.heading != blank %}
      <h2 class="bless-product__heading">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    {% if product and selected_variant %}
      <div
        class="bless-product__card"
        style="background-color: rgba({{ panel_rgb }}, {{ panel_opacity }})"
        data-product-card
      >
        <div class="bless-product__details">
          {% if section.settings.show_media and product.featured_media %}
            <div class="bless-product__media">
              {% assign featured_media = product.featured_media %}
              {% case featured_media.media_type %}
                {% when 'image' %}
                  {{
                    featured_media
                    | image_url: width: 960
                    | image_tag:
                      widths: '400, 600, 760, 900',
                      sizes: '(min-width: 768px) 360px, 80vw',
                      alt: featured_media.alt | default: product.title,
                      class: 'bless-product__image'
                  }}
                {% when 'video' %}
                  {{
                    featured_media
                    | video_tag:
                      controls: true,
                      muted: true,
                      loop: false,
                      playsinline: true,
                      class: 'bless-product__video'
                  }}
                {% when 'external_video' %}
                  {{
                    featured_media
                    | external_video_tag:
                      class: 'bless-product__video'
                  }}
                {% when 'model' %}
                  {{
                    featured_media
                    | model_viewer_tag:
                      class: 'bless-product__model'
                  }}
                {% else %}
                  {{
                    featured_media
                    | media_tag: class: 'bless-product__media-generic'
                  }}
              {% endcase %}
            </div>
          {% endif %}

          <div class="bless-product__content">
            <h3 class="bless-product__title">{{ product.title | escape }}</h3>

            {% if section.settings.show_price and selected_variant %}
              <p class="bless-product__price">
                {{ selected_variant.price | money_with_currency }}
              </p>
            {% endif %}

            {% if section.settings.show_description and product.description != blank %}
              <div class="bless-product__description">
                {{ product.description | strip_html | truncatewords: 80 }}
              </div>
            {% endif %}

            {%- form 'product', product, id: form_id, novalidate: 'novalidate', class: 'bless-product__form' -%}
              {% if selected_variant %}
                <input type="hidden" name="id" value="{{ selected_variant.id }}" data-variant-input>
              {% endif %}
              <input type="hidden" name="properties[{{ section.settings.property_key }}]" data-blessing-input>

              {% if section.settings.show_variant_picker and product.has_only_default_variant == false %}
                <label class="bless-product__label" for="VariantSelect-{{ section.id }}">
                  {{ section.settings.variant_label | escape }}
                </label>
                <select id="VariantSelect-{{ section.id }}" class="bless-product__select" data-variant-select>
                  {% for variant in product.variants %}
                    <option
                      value="{{ variant.id }}"
                      {% if variant.id == selected_variant.id %}selected{% endif %}
                      {% unless variant.available %}disabled{% endunless %}
                    >
                      {{ variant.title }}{% if section.settings.show_variant_prices %} â€” {{ variant.price | money }}{% endif %}
                    </option>
                  {% endfor %}
                </select>
              {% endif %}

              {% if section.settings.show_quantity_selector %}
                <label class="bless-product__label" for="Quantity-{{ section.id }}">
                  {{ 'products.product.quantity' | t }}
                </label>
                <input
                  id="Quantity-{{ section.id }}"
                  class="bless-product__quantity"
                  type="number"
                  name="quantity"
                  min="1"
                  value="1"
                >
              {% endif %}

              <button
                type="submit"
                class="bless-product__cta"
                data-submit
                {% if require_blessing %}disabled{% endif %}
              >
                {{ section.settings.button_label | escape }}
              </button>

              <p class="bless-product__note">
                {{ section.settings.cart_note | escape }}
              </p>
            {%- endform -%}
          </div>
        </div>
      </div>
    {% else %}
      <div class="bless-product__empty">
        <p>{{ 'templates.product.onboarding.no_product' | t }}</p>
      </div>
    {% endif %}
  </div>
</section>

{% stylesheet %}
.bless-product {
  position: relative;
  isolation: isolate;
  padding: clamp(3.5rem, 6vw, 7rem) 0;
  background-color: rgb(var(--color-light-flesh, 236, 227, 214));
  color: rgb(var(--color-dark-green, 46, 94, 76));
  display: flex;
  justify-content: center;
}

.bless-product__inner {
  width: min(1080px, 92vw);
  display: grid;
  gap: 2rem;
  text-align: center;
}

.bless-product__heading {
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(2.25rem, 3vw + 1.25rem, 3.25rem);
  margin: 0;
}

.bless-product__card {
  padding: clamp(2.5rem, 4vw, 3.5rem);
  border-radius: 36px;
  backdrop-filter: blur(10px);
  box-shadow: 0 32px 65px rgba(0, 0, 0, 0.18);
  border: 1px solid rgba(255, 255, 255, 0.25);
}

.bless-product__details {
  display: grid;
  gap: 2.5rem;
  align-items: start;
}

.bless-product__media {
  border-radius: 24px;
  overflow: hidden;
  box-shadow: 0 24px 50px rgba(0, 0, 0, 0.18);
}

.bless-product__image {
  width: 100%;
  height: auto;
  display: block;
}

.bless-product__video,
.bless-product__model,
.bless-product__media-generic {
  width: 100%;
  height: auto;
  display: block;
}

.bless-product__content {
  text-align: left;
  display: grid;
  gap: 1.25rem;
}

.bless-product__title {
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(1.9rem, 2vw + 1rem, 2.5rem);
  margin: 0;
}

.bless-product__price {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1.2rem;
  font-weight: 600;
  margin: 0;
}

.bless-product__description {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1rem;
  line-height: 1.75;
  color: rgba(var(--color-dark-green, 46, 94, 76), 0.85);
}

.bless-product__form {
  display: grid;
  gap: 1rem;
}

.bless-product__label {
  font-size: 0.95rem;
  font-weight: 600;
  letter-spacing: 0.02em;
}

.bless-product__select,
.bless-product__quantity {
  width: 100%;
  padding: 0.85rem 1rem;
  border-radius: 16px;
  border: 1px solid rgba(var(--color-dark-green, 46, 94, 76), 0.2);
  background: rgba(255, 255, 255, 0.6);
  font-size: 1rem;
}

.bless-product__cta {
  justify-self: start;
  padding: 0.95rem 2.5rem;
  border-radius: 999px;
  border: none;
  background: rgb(var(--color-dark-green, 46, 94, 76));
  color: rgb(var(--color-light-flesh, 236, 227, 214));
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: transform 200ms ease, background-color 200ms ease, opacity 200ms ease;
}

.bless-product__cta[disabled] {
  cursor: not-allowed;
  opacity: 0.6;
}

.bless-product__cta:not([disabled]):hover,
.bless-product__cta:not([disabled]):focus {
  transform: translateY(-2px);
  background: rgba(var(--color-dark-green, 46, 94, 76), 0.9);
}

.bless-product__note {
  font-size: 0.9rem;
  color: rgba(var(--color-dark-green, 46, 94, 76), 0.7);
  margin: 0;
}

.bless-product__empty {
  padding: 2rem;
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.4);
  font-family: var(--font-body, 'Albert Sans', sans-serif);
}

@media (min-width: 900px) {
  .bless-product__details {
    grid-template-columns: minmax(320px, 1fr) minmax(320px, 1fr);
  }
}

@media (max-width: 600px) {
  .bless-product__card {
    border-radius: 28px;
  }
}
{% endstylesheet %}

{% javascript %}
(function () {
  const sectionId = '{{ section.id }}';
  const sectionEl = document.querySelector(`[data-section-id="${sectionId}"]`);
  if (!sectionEl) return;

  const formEl = sectionEl.querySelector('form');
  const variantInput = sectionEl.querySelector('[data-variant-input]');
  const variantSelect = sectionEl.querySelector('[data-variant-select]');
  const blessingInput = sectionEl.querySelector('[data-blessing-input]');
  const submitButton = sectionEl.querySelector('[data-submit]');
  const requireBlessing = sectionEl.dataset.requireBlessing === 'true';

  if (variantSelect && variantInput) {
    variantSelect.addEventListener('change', () => {
      const selected = variantSelect.value;
      if (selected) {
        variantInput.value = selected;
      }
    });
  }

  function enableFormWithBlessing(text) {
    if (blessingInput) {
      blessingInput.value = text;
    }
    if (requireBlessing && submitButton) {
      submitButton.disabled = false;
    }
    sectionEl.classList.add('bless-product--active');
  }

  const updateKey = `__blessProductUpdate_${sectionId}`;
  if (window[updateKey]) {
    window.removeEventListener('blessing:update', window[updateKey]);
  }
  window[updateKey] = (event) => {
    const text = event?.detail?.text;
    if (!text) return;
    enableFormWithBlessing(text);
  };
  window.addEventListener('blessing:update', window[updateKey]);

  const errorKey = `__blessProductError_${sectionId}`;
  if (window[errorKey]) {
    window.removeEventListener('blessing:error', window[errorKey]);
  }
  window[errorKey] = () => {
    if (requireBlessing && submitButton) {
      submitButton.disabled = true;
    }
  };
  window.addEventListener('blessing:error', window[errorKey]);

  if (formEl && requireBlessing) {
    formEl.addEventListener('submit', (event) => {
      if (!blessingInput?.value) {
        event.preventDefault();
      }
    });
  }

  document.addEventListener('shopify:section:unload', (event) => {
    if (event.detail?.sectionId === sectionId) {
      if (window[updateKey]) {
        window.removeEventListener('blessing:update', window[updateKey]);
        delete window[updateKey];
      }
      if (window[errorKey]) {
        window.removeEventListener('blessing:error', window[errorKey]);
        delete window[errorKey];
      }
    }
  });
})();
{% endjavascript %}

{% schema %}
{
  "name": "Bless product",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Select the product that captures the blessing text as a line item property."
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Carry your blessing with you"
    },
    {
      "type": "text",
      "id": "panel_background",
      "label": "Panel background RGB",
      "default": "65, 65, 65",
      "info": "RGB value without opacity (for example: 65, 65, 65)."
    },
    {
      "type": "range",
      "id": "panel_opacity",
      "label": "Panel opacity",
      "default": 70,
      "min": 20,
      "max": 95,
      "step": 5,
      "unit": "%"
    },
    {
      "type": "checkbox",
      "id": "show_media",
      "label": "Show featured media",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show description excerpt",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_price",
      "label": "Show price",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_variant_picker",
      "label": "Show variant selector",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_variant_prices",
      "label": "Show variant price inside selector",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_quantity_selector",
      "label": "Show quantity selector",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "require_blessing",
      "label": "Require blessing before enabling purchase",
      "default": true
    },
    {
      "type": "text",
      "id": "variant_label",
      "label": "Variant label",
      "default": "Choose your option"
    },
    {
      "type": "text",
      "id": "property_key",
      "label": "Line item property key",
      "default": "Blessing"
    },
    {
      "type": "text",
      "id": "button_label",
      "label": "Button label",
      "default": "Add blessing to cart"
    },
    {
      "type": "text",
      "id": "cart_note",
      "label": "Cart note",
      "default": "We will include this blessing with your order."
    }
  ],
  "presets": [
    {
      "name": "Bless product"
    }
  ]
}
{% endschema %}
