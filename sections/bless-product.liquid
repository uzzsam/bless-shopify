{% liquid
  assign selected_sidthie = cart.attributes['selected_sidthie'] | default: '' | upcase
  assign product = nil

  if selected_sidthie != ''
    assign handle = selected_sidthie | downcase
    assign product = all_products[handle]
  else
    assign product = all_products[section.settings.product]
  endif

  assign selected_variant = nil
  if product
    assign selected_variant = product.selected_or_first_available_variant
  endif
  assign panel_rgb = section.settings.panel_background | default: '65, 65, 65'
  assign panel_opacity = section.settings.panel_opacity | default: 70 | times: 0.01
  assign require_blessing = section.settings.require_blessing | default: true
  assign form_id = 'BlessProductForm-' | append: section.id
%}

<section
  id="product-section"
  class="bless-product"
  data-section-id="{{ section.id }}"
  data-require-blessing="{{ require_blessing }}"
>
  <div class="bless-product__inner">
    {% if section.settings.heading != blank %}
      <h2 class="bless-product__heading">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    {% if product and selected_variant %}
      <div
        class="bless-product__card"
        style="background-color: rgba({{ panel_rgb }}, {{ panel_opacity }})"
        data-product-card
      >
        <div class="bless-product__details">
          {% if section.settings.show_media and product.featured_media %}
            <div class="bless-product__media">
              {% assign featured_media = product.featured_media %}
              {% case featured_media.media_type %}
                {% when 'image' %}
                  {{
                    featured_media
                    | image_url: width: 960
                    | image_tag:
                      widths: '400, 600, 760, 900',
                      sizes: '(min-width: 768px) 360px, 80vw',
                      alt: featured_media.alt | default: product.title,
                      class: 'bless-product__image'
                  }}
                {% when 'video' %}
                  {{
                    featured_media
                    | video_tag:
                      controls: true,
                      muted: true,
                      loop: false,
                      playsinline: true,
                      class: 'bless-product__video'
                  }}
                {% when 'external_video' %}
                  {{
                    featured_media
                    | external_video_tag:
                      class: 'bless-product__video'
                  }}
                {% when 'model' %}
                  {{
                    featured_media
                    | model_viewer_tag:
                      class: 'bless-product__model'
                  }}
                {% else %}
                  {{
                    featured_media
                    | media_tag: class: 'bless-product__media-generic'
                  }}
              {% endcase %}
            </div>
          {% endif %}

          <div class="bless-product__content">
            <h3 class="bless-product__title">{{ product.title | escape }}</h3>

            {% if section.settings.show_price and selected_variant %}
              <p class="bless-product__price">
                {{ selected_variant.price | money_with_currency }}
              </p>
            {% endif %}

            {% if section.settings.show_description and product.description != blank %}
              <div class="bless-product__description">
                {{ product.description | strip_html | truncatewords: 80 }}
              </div>
            {% endif %}

            {%- form 'product', product, id: form_id, novalidate: 'novalidate', class: 'bless-product__form' -%}
              {% if selected_variant %}
                <input type="hidden" name="id" value="{{ selected_variant.id }}" data-variant-input>
              {% endif %}
              <input type="hidden" name="properties[{{ section.settings.property_key }}]" data-blessing-input>

              {% if section.settings.show_variant_picker and product.has_only_default_variant == false %}
                <label class="bless-product__label" for="VariantSelect-{{ section.id }}">
                  {{ section.settings.variant_label | escape }}
                </label>
                <select id="VariantSelect-{{ section.id }}" class="bless-product__select" data-variant-select>
                  {% for variant in product.variants %}
                    <option
                      value="{{ variant.id }}"
                      {% if variant.id == selected_variant.id %}selected{% endif %}
                      {% unless variant.available %}disabled{% endunless %}
                    >
                      {{ variant.title }}{% if section.settings.show_variant_prices %} â€” {{ variant.price | money }}{% endif %}
                    </option>
                  {% endfor %}
                </select>
              {% endif %}

              {% if section.settings.show_quantity_selector %}
                <label class="bless-product__label" for="Quantity-{{ section.id }}">
                  {{ 'products.product.quantity' | t }}
                </label>
                <input
                  id="Quantity-{{ section.id }}"
                  class="bless-product__quantity"
                  type="number"
                  name="quantity"
                  min="1"
                  value="1"
                >
              {% endif %}

              <button
                type="submit"
                class="bless-product__cta"
                data-submit
                {% if require_blessing %}disabled{% endif %}
              >
                {{ section.settings.button_label | escape }}
              </button>

              <p class="bless-product__note">
                {{ section.settings.cart_note | escape }}
              </p>
            {%- endform -%}
          </div>
        </div>
      </div>
    {% else %}
      <div class="bless-product__empty">
        <p>No product found for this blessing.</p>
      </div>
    {% endif %}
  </div>
</section>

{% javascript %}
document.addEventListener('blessing:ready', (event) => {
  const blessingText = event.detail?.blessing;
  const sidthieMatch = blessingText?.match(/\b(LUMASARA|WELAMORA|NIRALUMA|RAKAWELA|OLANWELA|MORASARA)\b/i);
  if (sidthieMatch) {
    const chosenSidthie = sidthieMatch[1];
    fetch('/cart/update.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ attributes: { selected_sidthie: chosenSidthie } })
    }).then(() => location.reload());
  }
});
{% endjavascript %}
