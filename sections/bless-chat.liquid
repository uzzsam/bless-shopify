{% liquid
  assign section_id = section.id
  assign embed_script_url = section.settings.embed_script_url
  assign app_proxy_path = section.settings.app_proxy_path | default: '/apps/bless'
%}

<section
  id="chat-section"
  class="bless-chat"
  data-section-id="{{ section_id }}"
  data-bless-chat-section="true"
  data-embed-url="{{ embed_script_url | escape }}"
  data-app-proxy-path="{{ app_proxy_path | escape }}"
  data-api-url="{{ section.settings.chat_api_url | escape }}"
  data-placeholder="{{ section.settings.input_placeholder | escape }}"
  data-loading-text="{{ section.settings.loading_message | escape }}"
  data-error-text="{{ section.settings.error_message | escape }}"
>
  <div class="bless-chat__inner">
    {% if section.settings.heading != blank %}
      <h2 class="bless-chat__heading">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    {% if section.settings.intro_text != blank %}
      <p class="bless-chat__intro">
        {{ section.settings.intro_text }}
      </p>
    {% endif %}

    <div id="bless-chat-{{ section_id }}" class="bless-chat__embed" data-chat-container></div>

    <div
      class="bless-chat__status"
      data-status
      aria-live="polite"
      data-loading-text="{{ section.settings.loading_message | escape }}"
      data-error-text="{{ section.settings.error_message | escape }}"
      hidden
    ></div>
  </div>
</section>

{% stylesheet %}
.bless-chat {
  position: relative;
  isolation: isolate;
  padding: clamp(3rem, 5vw, 6rem) 0;
  background-color: transparent;
  color: rgb(var(--color-dark-green, 46, 94, 76));
}

.bless-chat__inner {
  width: min(960px, 90vw);
  margin: 0 auto;
  display: grid;
  gap: 1.75rem;
  justify-items: center;
  text-align: center;
}

.bless-chat__heading {
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(2rem, 3vw + 1rem, 3rem);
  margin: 0;
}

.bless-chat__intro {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1.1rem;
  line-height: 1.65;
  margin: 0;
  max-width: 720px;
}

.bless-chat__embed {
  width: 100%;
  min-height: 420px;
  border-radius: 24px;
  overflow: hidden;
  background: rgba(var(--color-light-green, 168, 204, 193), 0.25);
  backdrop-filter: blur(6px);
  box-shadow: 0 24px 50px rgba(0, 0, 0, 0.15);
}

.bless-chat__status {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1rem;
  padding: 0.75rem 1.5rem;
  border-radius: 999px;
  background: rgba(var(--color-avocado, 227, 216, 154), 0.25);
  color: rgb(var(--color-dark-green, 46, 94, 76));
}

@media (max-width: 600px) {
  .bless-chat__embed {
    border-radius: 18px;
    min-height: 360px;
  }
}
{% endstylesheet %}

{% unless bless_chat_init_script_included %}
  {{ 'bless-chat-init.js' | asset_url | script_tag }}
  {% assign bless_chat_init_script_included = true %}
{% endunless %}

{% schema %}
{
  "name": "Bless chat",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Begin your personalised blessing"
    },
    {
      "type": "richtext",
      "id": "intro_text",
      "label": "Intro text",
      "default": "<p>Our guide will ask a few heartfelt questions to craft a blessing meant just for you. Answer when you are ready.</p>"
    },
    {
      "type": "text",
      "id": "embed_script_url",
      "label": "Chatbot embed script URL",
      "info": "Paste the URL of the chatbot script hosted on Vercel."
    },
    {
      "type": "text",
      "id": "app_proxy_path",
      "label": "App proxy path",
      "default": "/apps/bless",
      "info": "Path to the Shopify App Proxy that forwards blessings to Vercel."
    },
    {
      "type": "text",
      "id": "chat_api_url",
      "label": "Chat API endpoint",
      "default": "https://bless-test-brown.vercel.app/api/chat",
      "info": "The Vercel endpoint that powers the conversation."
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Input placeholder",
      "default": "Talk to Sidthah"
    },
    {
      "type": "text",
      "id": "loading_message",
      "label": "Loading message",
      "default": "Breathe and await your blessing from Sidthah..."
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error message",
      "default": "We could not save your blessing. Please try again."
    }
  ],
  "presets": [
    {
      "name": "Bless chat"
    }
  ]
}
{% endschema %}
