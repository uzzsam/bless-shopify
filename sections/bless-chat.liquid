{% liquid
  assign section_id = section.id
  assign embed_script_url = section.settings.embed_script_url
  assign app_proxy_path = section.settings.app_proxy_path | default: '/apps/bless'
%}

<section
  id="chat-section"
  class="bless-chat"
  data-section-id="{{ section_id }}"
  data-embed-url="{{ embed_script_url | escape }}"
  data-app-proxy-path="{{ app_proxy_path | escape }}"
  data-api-url="{{ section.settings.chat_api_url | escape }}"
  data-placeholder="{{ section.settings.input_placeholder | escape }}"
  data-loading-text="{{ section.settings.loading_message | escape }}"
>
  <div class="bless-chat__inner">
    {% if section.settings.heading != blank %}
      <h2 class="bless-chat__heading">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    {% if section.settings.intro_text != blank %}
      <p class="bless-chat__intro">
        {{ section.settings.intro_text }}
      </p>
    {% endif %}

    <div id="bless-chat-{{ section_id }}" class="bless-chat__embed" data-chat-container></div>

    <div
      class="bless-chat__status"
      data-status
      aria-live="polite"
      data-loading-text="{{ section.settings.loading_message | escape }}"
      data-error-text="{{ section.settings.error_message | escape }}"
      hidden
    ></div>
  </div>
</section>

{% stylesheet %}
.bless-chat {
  position: relative;
  isolation: isolate;
  padding: clamp(3rem, 5vw, 6rem) 0;
  background-color: transparent;
  color: rgb(var(--color-dark-green, 46, 94, 76));
}

.bless-chat__inner {
  width: min(960px, 90vw);
  margin: 0 auto;
  display: grid;
  gap: 1.75rem;
  justify-items: center;
  text-align: center;
}

.bless-chat__heading {
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(2rem, 3vw + 1rem, 3rem);
  margin: 0;
}

.bless-chat__intro {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1.1rem;
  line-height: 1.65;
  margin: 0;
  max-width: 720px;
}

.bless-chat__embed {
  width: 100%;
  min-height: 420px;
  border-radius: 24px;
  overflow: hidden;
  background: rgba(var(--color-light-green, 168, 204, 193), 0.25);
  backdrop-filter: blur(6px);
  box-shadow: 0 24px 50px rgba(0, 0, 0, 0.15);
}

.bless-chat__status {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1rem;
  padding: 0.75rem 1.5rem;
  border-radius: 999px;
  background: rgba(var(--color-avocado, 227, 216, 154), 0.25);
  color: rgb(var(--color-dark-green, 46, 94, 76));
}

@media (max-width: 600px) {
  .bless-chat__embed {
    border-radius: 18px;
    min-height: 360px;
  }
}
{% endstylesheet %}

{% javascript %}
(function () {
  var sectionId = {{ section_id | json }};
  var SCRIPT_DATA_ATTR = 'data-bless-chat-src';
  var handlerKey = '__blessChatHandler_' + sectionId;
  var MAX_SECTION_LOOKUPS = 80;
  var SECTION_LOOKUP_DELAY = 125;

  var sectionLookupAttempts = 0;
  var currentSectionEl = null;
  var mountIntervalId = null;
  var loadListenerAttached = false;
  var unloadListenerAttached = false;
  var domReadyListenerAttached = false;

  function debug() {
    try {
      var args = Array.prototype.slice.call(arguments);
      args.unshift('[BlessChat][' + sectionId + ']');
      console.info.apply(console, args);
    } catch (_ignore) {
      /* no-op */
    }
  }

  function getClosestSection(el) {
    if (!el) return null;
    if (typeof el.closest === 'function') {
      return el.closest('[data-section-id]');
    }
    var node = el;
    while (node) {
      if (node.getAttribute && node.getAttribute('data-section-id')) {
        return node;
      }
      node = node.parentElement;
    }
    return null;
  }

  function resolveSectionElement() {
    var chatTarget = document.getElementById('bless-chat-' + sectionId);
    var wrapper = getClosestSection(chatTarget);
    if (
      wrapper &&
      wrapper.getAttribute &&
      wrapper.getAttribute('data-embed-url') !== null
    ) {
      return wrapper;
    }

    var selector = '[data-section-id="' + sectionId + '"][data-embed-url]';
    var byDataset = document.querySelector(selector);
    if (byDataset) return byDataset;

    var sectionContainer = document.getElementById('shopify-section-' + sectionId);
    if (sectionContainer) {
      var nested = sectionContainer.querySelector('[data-embed-url]');
      if (nested) return nested;
    }

    return null;
  }

  function mountSection(sectionEl) {
    if (!sectionEl) {
      return false;
    }

    if (sectionEl.getAttribute('data-bless-chat-initialized') === 'true') {
      return true;
    }

    currentSectionEl = sectionEl;
    sectionEl.setAttribute('data-bless-chat-initialized', 'true');

    var embedUrl = sectionEl.getAttribute('data-embed-url');
    var appProxyPath = sectionEl.getAttribute('data-app-proxy-path') || '/apps/bless';
    var apiUrl = sectionEl.getAttribute('data-api-url');
    var placeholder = sectionEl.getAttribute('data-placeholder');
    var loadingMessage = sectionEl.getAttribute('data-loading-text');
    var targetSelector = '#bless-chat-' + sectionId;
    var statusEl = sectionEl.querySelector('[data-status]');
    var loadingText =
      (statusEl && statusEl.getAttribute('data-loading-text')) ||
      'Finalising your blessing...';
    var errorTextDefault =
      (statusEl && statusEl.getAttribute('data-error-text')) ||
      'We could not save your blessing. Please try again.';

    function mountWidget() {
      if (window.BlessChat && typeof window.BlessChat.mount === 'function') {
        debug('Mounting widget', {
          targetSelector: targetSelector,
          apiUrl: apiUrl,
          placeholder: placeholder,
          loadingMessage: loadingMessage
        });
        window.BlessChat.mount(targetSelector, {
          apiUrl: apiUrl || undefined,
          placeholder: placeholder || undefined,
          loadingText: loadingMessage || undefined
        });
        return true;
      }
      debug('BlessChat.mount not available yet');
      return false;
    }

    if (embedUrl) {
      var script = document.querySelector(
        'script[' + SCRIPT_DATA_ATTR + '=\"' + embedUrl + '\"]'
      );
      if (!script) {
        debug('Creating script tag', embedUrl);
        script = document.createElement('script');
        script.src = embedUrl;
        script.defer = true;
        script.setAttribute(SCRIPT_DATA_ATTR, embedUrl);
        script.addEventListener('load', function () {
          script.setAttribute('data-bless-chat-ready', 'true');
          debug('Script loaded');
          mountWidget();
        });
        script.addEventListener('error', function (event) {
          debug(
            'Script failed to load',
            event && event.message ? event.message : event
          );
        });
        document.head.appendChild(script);
      } else if (script.getAttribute('data-bless-chat-ready') === 'true') {
        debug('Reusing existing script (ready)');
        mountWidget();
      } else {
        script.addEventListener('load', function () {
          script.setAttribute('data-bless-chat-ready', 'true');
          debug('Script loaded (existing tag)');
          mountWidget();
        });
        script.addEventListener('error', function (event) {
          debug(
            'Script failed to load (existing tag)',
            event && event.message ? event.message : event
          );
        });
        if (window.BlessChat && typeof window.BlessChat.mount === 'function') {
          debug('Mounting with existing BlessChat instance');
          mountWidget();
        }
      }
    } else {
      debug('No embed URL provided; attempting immediate mount');
      mountWidget();
    }

    if (mountIntervalId) {
      clearInterval(mountIntervalId);
    }
    var attemptCount = 0;
    mountIntervalId = setInterval(function () {
      attemptCount += 1;
      if (mountWidget() || attemptCount > 20) {
        clearInterval(mountIntervalId);
        mountIntervalId = null;
        if (attemptCount > 20) {
          debug('Stopped retrying mount after 20 attempts');
        }
      }
    }, 250);

    debug('Initial BlessChat availability', {
      hasBlessChat: Boolean(window.BlessChat)
    });

    function setStatus(message) {
      if (!statusEl) return;
      if (message) {
        statusEl.textContent = message;
        statusEl.hidden = false;
      } else {
        statusEl.textContent = '';
        statusEl.hidden = true;
      }
    }

    if (window[handlerKey]) {
      window.removeEventListener('blessing:ready', window[handlerKey]);
    }

    window[handlerKey] = function (event) {
      var detail = event && event.detail;
      var blessing = detail && (detail.blessing || detail.text);
      if (!blessing) return;

      setStatus(loadingText);

      fetch(appProxyPath, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blessing: blessing })
      })
        .then(function (response) {
          if (!response.ok) {
            throw new Error('Proxy responded with ' + response.status);
          }
          return response.json();
        })
        .then(function (payload) {
          var blessingText =
            (payload && payload.blessingText) || blessing;
          setStatus('');
          window.dispatchEvent(
            new CustomEvent('blessing:update', { detail: { text: blessingText } })
          );
        })
        .catch(function (error) {
          console.error('Bless chat proxy error', error);
          setStatus(errorTextDefault);
          window.dispatchEvent(
            new CustomEvent('blessing:error', {
              detail: { message: errorTextDefault, error: String(error) }
            })
          );
        });
    };

    window.addEventListener('blessing:ready', window[handlerKey]);

    return true;
  }

  function initialiseSection() {
    var sectionEl = resolveSectionElement();
    return mountSection(sectionEl);
  }

  function handleSectionLoad(event) {
    if (!event || !event.detail || event.detail.sectionId !== sectionId) {
      return;
    }

    var target =
      event.target && typeof event.target.querySelector === 'function'
        ? event.target
        : null;
    var sectionEl = target ? target.querySelector('[data-embed-url]') : null;
    if (!sectionEl) {
      sectionEl = resolveSectionElement();
    }

    if (sectionEl) {
      sectionEl.removeAttribute('data-bless-chat-initialized');
    }

    sectionLookupAttempts = 0;
    ensureSection();
  }

  function handleSectionUnload(event) {
    if (!event || !event.detail || event.detail.sectionId !== sectionId) {
      return;
    }

    if (mountIntervalId) {
      clearInterval(mountIntervalId);
      mountIntervalId = null;
    }
    if (currentSectionEl) {
      currentSectionEl.removeAttribute('data-bless-chat-initialized');
    }
    currentSectionEl = null;

    if (window[handlerKey]) {
      window.removeEventListener('blessing:ready', window[handlerKey]);
      delete window[handlerKey];
    }
  }

  function onDomReady() {
    document.removeEventListener('DOMContentLoaded', onDomReady);
    domReadyListenerAttached = false;
    ensureSection();
  }

  function attachEditorListeners() {
    if (!loadListenerAttached) {
      document.addEventListener('shopify:section:load', handleSectionLoad);
      loadListenerAttached = true;
    }
    if (!unloadListenerAttached) {
      document.addEventListener('shopify:section:unload', handleSectionUnload);
      unloadListenerAttached = true;
    }
  }

  function ensureSection() {
    if (initialiseSection()) {
      return;
    }

    if (document.readyState === 'loading') {
      if (!domReadyListenerAttached) {
        document.addEventListener('DOMContentLoaded', onDomReady);
        domReadyListenerAttached = true;
      }
      return;
    }

    sectionLookupAttempts += 1;
    if (sectionLookupAttempts <= MAX_SECTION_LOOKUPS) {
      setTimeout(ensureSection, SECTION_LOOKUP_DELAY);
    } else {
      debug('Unable to locate section element for initialization', {
        sectionId: sectionId
      });
    }
  }

  attachEditorListeners();
  ensureSection();
})();
{% endjavascript %}

{% schema %}
{
  "name": "Bless chat",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Begin your personalised blessing"
    },
    {
      "type": "richtext",
      "id": "intro_text",
      "label": "Intro text",
      "default": "<p>Our guide will ask a few heartfelt questions to craft a blessing meant just for you. Answer when you are ready.</p>"
    },
    {
      "type": "text",
      "id": "embed_script_url",
      "label": "Chatbot embed script URL",
      "info": "Paste the URL of the chatbot script hosted on Vercel."
    },
    {
      "type": "text",
      "id": "app_proxy_path",
      "label": "App proxy path",
      "default": "/apps/bless",
      "info": "Path to the Shopify App Proxy that forwards blessings to Vercel."
    },
    {
      "type": "text",
      "id": "chat_api_url",
      "label": "Chat API endpoint",
      "default": "https://bless-test-brown.vercel.app/api/chat",
      "info": "The Vercel endpoint that powers the conversation."
    },
    {
      "type": "text",
      "id": "input_placeholder",
      "label": "Input placeholder",
      "default": "Talk to Sidthah"
    },
    {
      "type": "text",
      "id": "loading_message",
      "label": "Loading message",
      "default": "Breathe and await your blessing from Sidthah..."
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error message",
      "default": "We could not save your blessing. Please try again."
    }
  ],
  "presets": [
    {
      "name": "Bless chat"
    }
  ]
}
{% endschema %}
