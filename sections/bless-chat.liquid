{% liquid
  assign widget_src = section.settings.widget_src | default: 'https://bless-test-brown.vercel.app/bless-chat-widget.js'
  assign panel_rgb = section.settings.panel_background | default: '236, 227, 214'
  assign panel_opacity = section.settings.panel_opacity | default: 45 | times: 0.01
%}

<section
  id="chat-section"
  class="bless-chat bless-overlay-30"
  data-section-id="{{ section.id }}"
>
  <div class="bless-chat__inner">
    {% if section.settings.heading != blank %}
      <h2 class="bless-chat__heading">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    <div
      class="bless-chat__panel"
      style="background-color: rgba({{ panel_rgb }}, {{ panel_opacity }})"
    >
      <!-- The chat widget mounts into this container -->
      <div
        class="bless-chat__container"
        data-chat-container
        data-api-url="{{ section.settings.api_url | escape }}"
        data-placeholder="{{ section.settings.placeholder | escape }}"
        data-loading-text="{{ section.settings.loading_text | escape }}"
      ></div>
    </div>
  </div>

  <script defer src="{{ widget_src }}"></script>
</section>

{% stylesheet %}
/* Section layout */
.bless-chat {
  position: relative;
  isolation: isolate;
  padding: clamp(3.5rem, 6vw, 7rem) 0;
  display: flex;
  justify-content: center;
  background: transparent;
}

/* Reusable 30% black overlay, same approach as blessing section */
.bless-overlay-30 { position: relative; z-index: 0; }
.bless-overlay-30::before {
  content: "";
  position: absolute; inset: 0;
  background: rgba(0,0,0,.30);
  z-index: -1;
  pointer-events: none;
}

/* Match width with Blessing section */
.bless-chat__inner {
  width: min(960px, 90vw);
  display: grid;
  gap: 2rem;
}

/* Heading: white and NOT uppercase */
.bless-chat__heading {
  margin: 0;
  color: #ffffff;
  text-transform: none; /* ensure small letters show */
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(2.25rem, 3vw + 1.25rem, 3.25rem);
  text-align: center;
}

/* Single panel only (remove any layered “under box”) */
.bless-chat__panel {
  position: relative;
  padding: clamp(1.9rem, 3.6vw, 2.8rem);
  border-radius: 32px;
  backdrop-filter: blur(14px);
  box-shadow: 0 28px 60px rgba(0,0,0,.18);
  border: 1px solid rgba(var(--color-light-flesh, 236, 227, 214), 0.25);
}

.bless-chat__panel::after {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: inherit;
  border: 1px solid rgba(255,255,255,0.18);
  pointer-events: none;
}

/* The element our widget mounts into */
.bless-chat__container {
  /* no extra shadow/box here: the widget handles its own bubbles */
}

/* Make sure any headings the widget renders don’t get uppercased by theme resets */
.bless-chat h1,
.bless-chat h2,
.bless-chat h3,
.bless-chat h4 {
  text-transform: none;
}

/* Force the widget to respect our width by not overflowing */
.bless-chat .bless-chat-shell {
  width: 100% !important;
  margin: 0 auto;
}
{% endstylesheet %}

{% javascript %}
(function () {
  const sectionId = '{{ section.id }}';
  const sectionEl = document.querySelector(`[data-section-id="${sectionId}"]`);
  if (!sectionEl) return;

  // If the widget script has already mounted elsewhere on the page,
  // this ensures it also mounts into this section's container.
  function tryMount() {
    if (window.BlessChat && typeof window.BlessChat.mount === 'function') {
      // Mount with defaults from data-*; sizing is controlled by CSS above
      window.BlessChat.mount('[data-section-id="{{ section.id }}"] [data-chat-container]');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryMount, { once: true });
  } else {
    // Defer to allow the <script src="{{ widget_src }}"> to load
    setTimeout(tryMount, 0);
  }

  // Clean up if section is removed in the editor
  document.addEventListener('shopify:section:unload', (ev) => {
    if (ev.detail?.sectionId === sectionId) {
      // no-op; widget is ephemeral and cleans up on next mount
    }
  });
})();
{% endjavascript %}

{% schema %}
{
  "name": "Bless chat",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Talk to Sidthah"
    },
    {
      "type": "url",
      "id": "widget_src",
      "label": "Chat widget JS URL",
      "default": "https://bless-test-brown.vercel.app/bless-chat-widget.js",
      "info": "Leave as-is unless you host the widget elsewhere."
    },
    {
      "type": "text",
      "id": "api_url",
      "label": "API URL override (optional)",
      "info": "Leave blank to use the widget default."
    },
    {
      "type": "text",
      "id": "placeholder",
      "label": "Input placeholder",
      "default": "Talk to Sidthah"
    },
    {
      "type": "text",
      "id": "loading_text",
      "label": "Loading text",
      "default": "Listening..."
    },
    {
      "type": "text",
      "id": "panel_background",
      "label": "Panel background RGB",
      "default": "236, 227, 214"
    },
    {
      "type": "range",
      "id": "panel_opacity",
      "label": "Panel opacity",
      "default": 45,
      "min": 10,
      "max": 100,
      "step": 5,
      "unit": "%"
    }
  ],
  "presets": [
    { "name": "Bless chat" }
  ]
}
{% endschema %}
