{% liquid
  assign panel_rgb = section.settings.panel_background | default: '236, 227, 214'
  assign panel_opacity = section.settings.panel_opacity | default: 60 | times: 0.01
%}

<section
  id="blessing-section"
  class="bless-blessing bless-overlay-30"
  data-section-id="{{ section.id }}"
  data-auto-scroll="{{ section.settings.auto_scroll | default: false }}"
>
  <div class="bless-blessing__inner">
    {% if section.settings.heading != blank %}
      <h2 class="bless-blessing__heading">
        {{ section.settings.heading | escape }}
      </h2>
    {% endif %}

    <div
      class="bless-blessing__panel"
      style="background-color: rgba({{ panel_rgb }}, {{ panel_opacity }})"
      data-blessing-panel
    >
      <p class="bless-blessing__placeholder" data-placeholder>
        {{ section.settings.placeholder_text | escape }}
      </p>
      <div class="bless-blessing__content" data-blessing-output hidden></div>

      <div class="bless-blessing__meta" data-blessing-meta hidden>
        <h3 class="bless-blessing__meta-title" data-sidthie-title hidden></h3>
        <p class="bless-blessing__meta-text" data-sidthie-excerpt hidden></p>
      </div>

      {% if section.settings.show_signup %}
        <form class="bless-blessing__signup bless-blessing__signup-form" data-blessing-signup hidden novalidate>
          <input type="hidden" name="sidthie" data-signup-sidthie>
          <label
            class="bless-blessing__signup-label"
            data-signup-prompt
            data-default-prompt="{{ section.settings.signup_prompt | escape }}"
          >
            {{ section.settings.signup_prompt | escape }}
          </label>
          <div class="bless-blessing__signup-row">
            <input
              type="email"
              name="email"
              class="bless-blessing__signup-input"
              placeholder="{{ section.settings.signup_placeholder | escape }}"
              required
            >
            <button type="submit" class="bless-blessing__signup-button" data-signup-submit>
              {{ section.settings.signup_button_label | escape }}
            </button>
          </div>
          <p class="bless-blessing__signup-feedback" data-signup-feedback hidden>
            {{ section.settings.signup_success | escape }}
          </p>
        </form>
      {% endif %}

      {% if section.settings.show_copy_button %}
        <button type="button" class="bless-blessing__copy" data-copy-trigger>
          {{ section.settings.copy_button_label | escape }}
        </button>
        <span class="bless-blessing__copy-feedback" data-copy-feedback hidden>
          {{ section.settings.copy_feedback | escape }}
        </span>
      {% endif %}
    </div>
  </div>
</section>

{% stylesheet %}
.bless-blessing {
  position: relative;
  isolation: isolate;
  padding: clamp(3.5rem, 6vw, 7rem) 0;
  background: transparent;
  display: flex;
  justify-content: center;
  color: #ffffff; /* ensure white base text color */
}

/* self-contained 30% black overlay (donâ€™t depend on other sections) */
.bless-overlay-30 { position: relative; z-index: 0; }
.bless-overlay-30::before {
  content: "";
  position: absolute; inset: 0;
  background: rgba(0,0,0,.30);
  border-radius: 0; /* section spans full width */
  z-index: -1;       /* sits behind content but above bg image */
  pointer-events: none;
}

.bless-blessing__inner {
  width: min(960px, 90vw);
  display: grid;
  gap: 2rem;
  text-align: center;
}

.bless-blessing__heading {
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(2.25rem, 3vw + 1.25rem, 3.25rem);
  margin: 0;
  color: #ffffff; /* white heading */
}

/* the frosted blessing panel */
.bless-blessing__panel {
  position: relative;
  padding: clamp(2rem, 4vw, 3rem);
  border-radius: 32px;
  backdrop-filter: blur(12px);
  box-shadow: 0 28px 60px rgba(0, 0, 0, 0.18);
  border: 1px solid rgba(var(--color-light-flesh, 236, 227, 214), 0.25);
}

.bless-blessing__panel::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: inherit;
  border: 1px solid rgba(255, 255, 255, 0.25);
  pointer-events: none;
}

.bless-blessing__placeholder,
.bless-blessing__content {
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  line-height: 1.8;
  margin: 0;
  white-space: pre-line;
  color: #ffffff; /* white for both placeholder + blessing text */
}

/* Load the Cormorant Upright font used for blessings */
@import url('https://fonts.googleapis.com/css2?family=Cormorant+Upright:wght@400;600&display=swap');

/* Apply decorative font + slightly smaller size for better fit */
.bless-blessing__content {
  font-family: 'Cormorant Upright', serif;
  text-align: center;
  font-size: clamp(1.05rem, 1.4vw, 1.25rem);
  line-height: 1.6;
}

.bless-blessing__meta {
  margin-top: 1.75rem;
  display: grid;
  gap: 0.75rem;
  text-align: left;
  color: rgba(255, 255, 255, 0.92);
}

.bless-blessing__meta-title {
  margin: 0;
  font-family: var(--font-heading, 'Cardo', serif);
  font-size: clamp(1.35rem, 1.2vw + 1rem, 1.75rem);
}

.bless-blessing__meta-text {
  margin: 0;
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  line-height: 1.7;
}

.bless-blessing__signup {
  margin-top: clamp(1.75rem, 3vw, 2.5rem);
  display: grid;
  gap: 0.75rem;
  text-align: left;
}

.bless-blessing__signup-label {
  margin: 0;
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-size: 1rem;
  color: rgba(255, 255, 255, 0.9);
}

.bless-blessing__signup-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.bless-blessing__signup-input {
  flex: 1 1 220px;
  min-width: 0;
  padding: 0.8rem 1rem;
  border-radius: 18px;
  border: none;
  font-size: 1rem;
}

.bless-blessing__signup-button {
  padding: 0.8rem 1.75rem;
  border-radius: 999px;
  border: none;
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-weight: 600;
  cursor: pointer;
  background: rgba(var(--color-avocado, 227, 216, 154), 0.92);
  color: rgb(var(--color-dark-green, 46, 94, 76));
  transition: transform 200ms ease, background-color 200ms ease;
}

.bless-blessing__signup-button:hover,
.bless-blessing__signup-button:focus {
  transform: translateY(-1px);
  background: rgba(var(--color-avocado, 227, 216, 154), 1);
}

.bless-blessing__signup-feedback {
  margin: 0;
  font-size: 0.95rem;
  color: rgba(255, 255, 255, 0.78);
}

.bless-blessing__signup-feedback--error {
  color: rgba(255, 180, 171, 0.95);
}

.bless-blessing__panel.is-visible .bless-blessing__content {
  animation: bless-fade-up 500ms ease forwards;
}

.bless-blessing__copy {
  margin-top: 1.75rem;
  padding: 0.75rem 1.75rem;
  border-radius: 999px;
  border: none;
  font-family: var(--font-body, 'Albert Sans', sans-serif);
  font-weight: 600;
  cursor: pointer;
  background: rgba(var(--color-avocado, 227, 216, 154), 0.92);
  color: rgb(var(--color-dark-green, 46, 94, 76));
  transition: transform 200ms ease, background-color 200ms ease;
}

.bless-blessing__copy:hover,
.bless-blessing__copy:focus {
  transform: translateY(-1px);
  background: rgba(var(--color-avocado, 227, 216, 154), 1);
}

.bless-blessing__copy-feedback {
  display: inline-block;
  margin-left: 0.75rem;
  font-size: 0.95rem;
  color: rgba(255,255,255,0.85);
}

@keyframes bless-fade-up {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

@media (max-width: 520px) {
  .bless-blessing__signup-row {
    flex-direction: column;
    align-items: stretch;
  }

  .bless-blessing__signup-button {
    width: 100%;
  }
}
{% endstylesheet %}

{% javascript %}
(function () {
  const sectionId = '{{ section.id }}';
  const sectionEl = document.querySelector(`[data-section-id="${sectionId}"]`);
  if (!sectionEl) return;

  const panelEl = sectionEl.querySelector('[data-blessing-panel]');
  const placeholderEl = sectionEl.querySelector('[data-placeholder]');
  const contentEl = sectionEl.querySelector('[data-blessing-output]');
  const metaWrapper = sectionEl.querySelector('[data-blessing-meta]');
  const metaTitleEl = sectionEl.querySelector('[data-sidthie-title]');
  const metaTextEl = sectionEl.querySelector('[data-sidthie-excerpt]');
  const signupWrapper = sectionEl.querySelector('[data-blessing-signup]');
  const signupPrompt = sectionEl.querySelector('[data-signup-prompt]');
  const signupSidthieInput = sectionEl.querySelector('[data-signup-sidthie]');
  const copyTrigger = sectionEl.querySelector('[data-copy-trigger]');
  const copyFeedback = sectionEl.querySelector('[data-copy-feedback]');
  const autoScroll = sectionEl.dataset.autoScroll === 'true';
  const defaultSignupPrompt = signupPrompt?.getAttribute('data-default-prompt') || signupPrompt?.textContent || '';

  function revealBlessing(detail) {
    if (!contentEl || !panelEl) return;
    const blessing = detail?.blessing || detail?.text;
    if (!blessing) return;

    if (placeholderEl) {
      placeholderEl.hidden = true;
    }

    contentEl.textContent = blessing;
    contentEl.hidden = false;
    panelEl.classList.add('is-visible');

    if (metaWrapper) {
      const hasLabel = Boolean(detail?.sidthieLabel);
      const hasExplanation = Boolean(detail?.explanation);

      if (metaTitleEl) {
        if (hasLabel) {
          metaTitleEl.textContent = detail.sidthieLabel;
          metaTitleEl.removeAttribute('hidden');
        } else {
          metaTitleEl.setAttribute('hidden', 'hidden');
        }
      }

      if (metaTextEl) {
        if (hasExplanation) {
          metaTextEl.textContent = detail.explanation;
          metaTextEl.removeAttribute('hidden');
        } else {
          metaTextEl.setAttribute('hidden', 'hidden');
        }
      }

      if (hasLabel || hasExplanation) {
        metaWrapper.removeAttribute('hidden');
      } else {
        metaWrapper.setAttribute('hidden', 'hidden');
      }
    }

    if (signupWrapper) {
      signupWrapper.removeAttribute('hidden');
      if (signupPrompt) {
        if (defaultSignupPrompt.includes('{sidthie}')) {
          signupPrompt.textContent = defaultSignupPrompt.replace(
            '{sidthie}',
            detail?.sidthieLabel || 'your Sidthie'
          );
        } else if (detail?.sidthieLabel) {
          signupPrompt.textContent = `${defaultSignupPrompt} (${detail.sidthieLabel})`;
        }
      }

      if (signupSidthieInput) {
        signupSidthieInput.value = detail?.sidthie || detail?.sidthieLabel || '';
      }
    }

    if (autoScroll) {
      panelEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function resetCopyFeedback() {
    if (copyFeedback) copyFeedback.hidden = true;
  }

  const updateKey = `__blessBlessingUpdate_${sectionId}`;
  if (window[updateKey]) {
    window.removeEventListener('blessing:update', window[updateKey]);
  }
  window[updateKey] = (event) => {
    const detail = event?.detail;
    if (!detail) return;
    revealBlessing(detail);
    resetCopyFeedback();
  };
  window.addEventListener('blessing:update', window[updateKey]);

  const errorKey = `__blessBlessingError_${sectionId}`;
  if (window[errorKey]) {
    window.removeEventListener('blessing:error', window[errorKey]);
  }
  window[errorKey] = () => {
    resetCopyFeedback();
    if (metaWrapper) metaWrapper.hidden = true;
    if (signupWrapper) signupWrapper.hidden = true;
    if (contentEl) contentEl.hidden = true;
    if (placeholderEl) placeholderEl.hidden = false;
  };
  window.addEventListener('blessing:error', window[errorKey]);

  if (copyTrigger && contentEl) {
    copyTrigger.addEventListener('click', async () => {
      const text = contentEl.textContent?.trim();
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        if (copyFeedback) copyFeedback.hidden = false;
      } catch (error) {
        console.error('Unable to copy blessing', error);
      }
    });
  }

  document.addEventListener('shopify:section:unload', (event) => {
    // no-op
  });
})();
{% endjavascript %}

{% schema %}
{
  "name": "Blessing reveal",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Your blessing"
    },
    {
      "type": "text",
      "id": "placeholder_text",
      "label": "Placeholder text",
      "default": "Complete the conversation to reveal your personalised blessing."
    },
    {
      "type": "checkbox",
      "id": "show_signup",
      "label": "Show signup form",
      "default": true
    },
    {
      "type": "text",
      "id": "signup_prompt",
      "label": "Signup prompt",
      "default": "Would you like to receive your Sidthie and blessing and free monthly wisdoms from Sidthah?"
    },
    {
      "type": "text",
      "id": "signup_placeholder",
      "label": "Email placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "signup_button_label",
      "label": "Signup button label",
      "default": "Receive wisdom"
    },
    {
      "type": "text",
      "id": "signup_success",
      "label": "Signup success message",
      "default": "Thank you. Your wisdom will arrive soon."
    },
    {
      "type": "text",
      "id": "panel_background",
      "label": "Panel background RGB",
      "info": "RGB value without opacity (for example: 236, 227, 214).",
      "default": "236, 227, 214"
    },
    {
      "type": "range",
      "id": "panel_opacity",
      "label": "Panel opacity",
      "default": 60,
      "min": 10,
      "max": 100,
      "step": 5,
      "unit": "%"
    },
    {
      "type": "checkbox",
      "id": "show_copy_button",
      "label": "Show copy to clipboard button",
      "default": true
    },
    {
      "type": "text",
      "id": "copy_button_label",
      "label": "Copy button label",
      "default": "Copy blessing"
    },
    {
      "type": "text",
      "id": "copy_feedback",
      "label": "Copy confirmation text",
      "default": "Copied!"
    },
    {
      "type": "checkbox",
      "id": "auto_scroll",
      "label": "Auto-scroll into view when blessing is ready",
      "default": true
    }
  ],
  "presets": [
    { "name": "Blessing reveal" }
  ]
}
{% endschema %}
